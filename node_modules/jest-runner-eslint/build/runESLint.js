'use strict';

var _require = require('create-jest-runner'),
    pass = _require.pass,
    fail = _require.fail,
    skip = _require.skip;

var getLocalESLint = require('./utils/getLocalESLint');
var getESLintOptions = require('./utils/getESLintOptions');

var runESLint = function runESLint(_ref) {
  var testPath = _ref.testPath,
      config = _ref.config;

  var start = Date.now();

  if (config.setupTestFrameworkScriptFile) {
    // eslint-disable-next-line import/no-dynamic-require,global-require
    require(config.setupTestFrameworkScriptFile);
  }

  var _getLocalESLint = getLocalESLint(config),
      CLIEngine = _getLocalESLint.CLIEngine;

  var options = getESLintOptions(config);
  var cli = new CLIEngine(options.cliOptions);
  if (cli.isPathIgnored(testPath)) {
    var _end = Date.now();
    return skip({ start, end: _end, test: { path: testPath, title: 'ESLint' } });
  }

  var report = cli.executeOnFiles([testPath]);

  if (options.cliOptions && options.cliOptions.fix) {
    CLIEngine.outputFixes(report);
  }

  var end = Date.now();

  if (report.errorCount > 0) {
    var formatter = cli.getFormatter(options.cliOptions.format);
    var errorMessage = formatter(CLIEngine.getErrorResults(report.results));

    return fail({
      start,
      end,
      test: { path: testPath, title: 'ESLint', errorMessage }
    });
  }

  return pass({ start, end, test: { path: testPath, title: 'ESLint' } });
};

module.exports = runESLint;